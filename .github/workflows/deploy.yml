name: æ„å»ºå¹¶éƒ¨ç½²åˆ° AWS S3

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    # è®¾ç½® Node.js ç¯å¢ƒ
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # å®‰è£…ä¾èµ–
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    # æ„å»ºé¡¹ç›®
    - name: æ„å»ºé¡¹ç›®
      run: npm run build
      
    # é…ç½® AWS å‡­è¯
    - name: é…ç½® AWS å‡­è¯
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
        
    # åŒæ­¥åˆ° S3 å­˜å‚¨æ¡¶
    - name: åŒæ­¥åˆ° S3
      run: |
        aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_NAME }} --delete
        
    # æ¸…é™¤ CloudFront ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
    - name: æ¸…é™¤ CloudFront ç¼“å­˜
      if: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID != '' }}
      run: |
        aws cloudfront create-invalidation \
          --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
          --paths "/*"
          
    # éƒ¨ç½²å®Œæˆé€šçŸ¥
    - name: éƒ¨ç½²å®Œæˆ
      run: |
        echo "ğŸš€ éƒ¨ç½²å®Œæˆï¼"
        echo "ç½‘ç«™åœ°å€: http://${{ secrets.S3_BUCKET_NAME }}.s3-website-${{ secrets.AWS_REGION }}.amazonaws.com" 